{% load static %}
<link rel="stylesheet" href="{% static 'css/reviews.css' %}">

{# Write Review Form #}

{# review writing/editing available only to registered users #}
{% if user.is_authenticated %}
    {# only allow user to write review if they are not the game's creator #}
    {% if user.id != game.user_id %}
        <div id="write-review" class="card bg-transparent mt-4">
            <div class="card-header">
                <h6>Write Review</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'add_review' game.id %}">
                    {% csrf_token %}
                    <textarea class="form-control mb-3" name="content"></textarea>
                    <label for="rating-input">
                        Rating
                    </label>
                    <select id="rating-input" class="ms-2" name="rating">
                        <option value="5">5</option>
                        <option value="4">4</option>
                        <option value="3">3</option>
                        <option value="2">2</option>
                        <option value="1">1</option>
                    </select>
                    <div class="float-end">
                        <button class="btn btn-secondary" type="submit">Submit</button>
                    </div>

                </form>
            </div>
        </div>
    {% endif %}
    {% include 'review/include/edit-modal.html' %}

    <script>
        window.addEventListener("load", () => {
            if (!bootstrap) {
                console.error("Bootstrap 5.3 was not found: plase load it for review edit modal to function.");
                return;
            }
            const btns = document.getElementsByClassName("edit-review-btn");

            for (const btn of btns) {
                btn.addEventListener("click", () => {
                    const reviewId = btn.dataset["review-id"];
                    const reviewElId = "review-" + reviewId;

                    // Find all necessary elements to do work

                    const editForm = document.getElementById("edit-form");
                    if (!editForm) {
                        console.error("Failed to find review edit form");
                        return;
                    }

                    const deleteReviewForm = document.getElementById("delete-review-form");
                    if (!deleteReviewForm) {
                        console.error("Failed to find delete review form");
                        return;
                    }

                    // Get content and rating from corresponding review
                    const reviewContentEl = document.querySelector(`#${reviewElId} .review-content`);
                    if (!reviewContentEl) {
                        console.error("Failed to find review content element");
                        return;
                    }

                    const reviewRatingEl = document.querySelector(`#${reviewElId} .review-rating`);
                    if (!reviewRatingEl) {
                        console.error("Failed to find review rating element");
                        return;
                    }

                    // get edit form inputs
                    const editTextEl = document.getElementById("edit-text");
                    if (!editTextEl) {
                        console.error("Failed to find edit modal text element");
                        return;
                    }

                    const editRatingEl = document.getElementById("edit-rating");
                    if (!editRatingEl) {
                        console.error("Failed to find edit modal rating element");
                        return;
                    }

                    const editModal = new bootstrap.Modal(document.getElementById('edit-modal'));


                    // found everything, now commit changes

                    const reviewContent = reviewContentEl.innerText;
                    const reviewRating = reviewRatingEl.innerText;

                    console.log(reviewRatingEl);

                    // set form actions to point to review id info
                    deleteReviewForm.setAttribute("action", '{% url "delete_review" 0 %}'.replace('0', reviewId));
                    editForm.setAttribute("action", '{% url "edit_review" 0 %}'.replace('0', reviewId));

                    editTextEl.value = reviewContent;
                    editRatingEl.value = reviewRating;

                    editModal.show();
                });
            }
        });
    </script>
{% endif %}


{# posted reviews for game #}
<div class="mb-5">
    {% for review in game.review_set.all %}
        <div id="review-{{ review.id }}" class="card bg-transparent pt-3 ps-4 pe-4 pb-2 mt-4 mb-4 shadow-sm border-1 border-secondary-subtle">
            {# Rating #}
            <span class="text-secondary position-absolute end-0 me-3 text-end">Rating: <span class="review-rating">{{ review.rating }}</span>/5</span>

            {# Edit button #}
            {% if user.is_authenticated and user == review.user %}
            <div class="position-absolute end-0 bottom-0 me-2 mb-2">
                <button type="button" class="btn text-secondary edit-review-btn" style="width:60px;padding:0;" data-review-id="{{ review.id }}">
                    <i class="bi bi-pencil-fill"></i> Edit
                </button>
            </div>
            {% endif %}

            <div class="review-headeri mb-0">
                <div class="">
                    {% comment %} <img src="{{user.profile.avatar.url }}" alt="User Avatar"> {% endcomment %}
                    <p class="mb-0">by <a class="text-decoration-none d-inline nav-link">{{ review.user.username }}</a></p>
                    <p class="text-secondary text-tiny">{{ review.created_at }}</p>
                </div>

            </div>

            <p class="review-content">{{ review.content }}</p>

        </div>
    {% endfor %}
</div>


